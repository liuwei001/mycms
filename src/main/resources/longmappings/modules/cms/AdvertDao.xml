<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.klht.modules.cms.dao.AdvertDao">
    
	<sql id="allColumns">
		t1.ID,
        t1.CREATE_BY AS "createBy.id",
        t1.CREATE_DATE, 
        t1.UPDATE_BY AS "updateBy.id",
        t1.UPDATE_DATE,
        t1.DEL_FLAG,
        t1.AD_NAME,t1.AD_PLACE_ID,t1.AD_CONTENT,t1.AD_URL,t1.AD_START_TM,t1.AD_END_TM,t1.AD_VALID_PERIOD,
        t1.AD_DESC,t1.TYPE,t1.AD_TYPE_ID,t1.VIP_NAME,t1.STATUS,
        t1.place_pixel_x,
		t1.place_pixel_y,
		t1.sort
	</sql>
	
	<select id="get" resultType="AdVert">
		SELECT 
			<include refid="allColumns"/>,
			t2.NAME as adTypeName,
			t3.PLACE_NAME as adPlaceName
		FROM CMS_TB_ADVERT t1,CMS_TB_CLASSIFY t2,CMS_TB_AD_Place t3
		WHERE t1.id = #{id} and t1.AD_TYPE_ID = t2.ID and t1.AD_PLACE_ID = t3.ID
	</select>
	
	<select id="findList" resultType="AdVert">
		SELECT 
			t1.ID,t1.AD_NAME,t1.AD_PLACE_ID,t1.AD_START_TM,t1.AD_END_TM,t1.STATUS,t1.TYPE,t1.AD_TYPE_ID,t1.VIP_NAME,
			t2.NAME as adTypeName,
			t3.PLACE_NAME as adPlaceName
		FROM CMS_TB_ADVERT t1,CMS_TB_CLASSIFY t2,CMS_TB_AD_Place t3
		where t1.del_flag = #{DEL_FLAG_NORMAL} and t1.AD_TYPE_ID = t2.ID and t1.AD_PLACE_ID = t3.ID
		<if test="adName != null and adName != ''">
	  		AND t1.AD_NAME LIKE
	  		<if test="dbName == 'oracle'">'%'||#{adName}||'%'</if>
			<if test="dbName == 'mysql'">CONCAT('%', #{adName}, '%')</if>
		</if>
		<if test="status != null and status != -1">
	  		AND t1.STATUS = #{status}
		</if>
		<if test="type != null and type == 0">
	  		AND t1.TYPE = #{type}
		</if>
		<if test="type != null and type == 1">
	  		AND t1.TYPE = #{type}
	  		<if test="vipName != null and vipName != ''">
		  		AND t1.VIP_NAME LIKE
		  		<if test="dbName == 'oracle'">'%'||#{vipName}||'%'</if>
				<if test="dbName == 'mysql'">CONCAT('%', #{vipName}, '%')</if>
	  		</if>
		</if>
		<if test="beginDate != null and beginDate != ''">
				AND t1.AD_START_TM <![CDATA[ >= #{beginDate} ]]>
			</if>
			<if test="endDate != null and endDate != ''">
				AND t1.AD_END_TM <![CDATA[ <= #{endDate} ]]>
			</if>
		ORDER BY decode(t1.status,1,1,4,2,2,3,3,4,5,5),t1.update_date DESC
	</select>
	<select id="findAuditList" resultType="AdVert">
		SELECT 
			t1.ID,t1.AD_NAME,t1.AD_PLACE_ID,t1.AD_START_TM,t1.AD_END_TM,t1.STATUS,t1.TYPE,t1.AD_TYPE_ID,t1.VIP_NAME,
			t2.NAME as adTypeName,
			t3.PLACE_NAME as adPlaceName
		FROM CMS_TB_ADVERT t1,CMS_TB_CLASSIFY t2,CMS_TB_AD_Place t3
		where t1.del_flag = #{DEL_FLAG_NORMAL} and t1.AD_TYPE_ID = t2.ID and t1.AD_PLACE_ID = t3.ID and t1.status != 1
		<if test="adName != null and adName != ''">
	  		AND t1.AD_NAME LIKE
	  		<if test="dbName == 'oracle'">'%'||#{adName}||'%'</if>
			<if test="dbName == 'mysql'">CONCAT('%', #{adName}, '%')</if>
		</if>
		<if test="status != null and status != -1">
	  		AND t1.STATUS = #{status}
		</if>
		<if test="type != null and type == 0">
	  		AND t1.TYPE = #{type}
		</if>
		<if test="type != null and type == 1">
	  		AND t1.TYPE = #{type}
	  		<if test="vipName != null and vipName != ''">
		  		AND t1.VIP_NAME LIKE
		  		<if test="dbName == 'oracle'">'%'||#{vipName}||'%'</if>
				<if test="dbName == 'mysql'">CONCAT('%', #{vipName}, '%')</if>
	  		</if>
		</if>
		<if test="beginDate != null and beginDate != ''">
				AND t1.AD_START_TM <![CDATA[ >= #{beginDate} ]]>
			</if>
			<if test="endDate != null and endDate != ''">
				AND t1.AD_END_TM <![CDATA[ <= #{endDate} ]]>
			</if>
		ORDER BY t1.status,t1.update_date DESC
	</select>
	
	<insert id="insert">
		<selectKey keyProperty="id" resultType="long" order="BEFORE">
	     	select SEQ_CMS_TB_ADVERT.nextval from dual
	    </selectKey>
		INSERT INTO CMS_TB_ADVERT(
			id,
			CREATE_BY,
        	CREATE_DATE, 
        	UPDATE_BY,
        	UPDATE_DATE, 
        	DEL_FLAG,
			AD_NAME,AD_PLACE_ID,AD_CONTENT,AD_URL,AD_START_TM,AD_END_TM,AD_VALID_PERIOD,AD_DESC,TYPE,AD_TYPE_ID,STATUS,
			place_pixel_x,
			place_pixel_y,
			sort
		) VALUES (
			#{id},
			#{createBy.id},  
			#{createDate}, 
			#{updateBy.id},  
			#{updateDate},
			#{DEL_FLAG_NORMAL},
			#{adName},
			#{adPlaceId},
			#{adContent},
			#{adUrl},
			#{adStartTm},
			#{adEndTm},
			#{adValidPeriod},
			#{adDesc},
			#{type},
			#{adTypeId},
			#{status},
			#{placePixelX},
			#{placePixelY},
			#{sort}
		)
	</insert>
	
	<update id="update">
		UPDATE CMS_TB_ADVERT SET 	
			AD_NAME = #{adName},
			AD_PLACE_ID = #{adPlaceId},
			AD_CONTENT = #{adContent},
			AD_URL = #{adUrl},
			AD_START_TM = #{adStartTm},
			AD_END_TM = #{adEndTm},
			AD_VALID_PERIOD = #{adValidPeriod},
			AD_DESC = #{adDesc},
			AD_TYPE_ID = #{adTypeId},
			STATUS = #{status},
			place_pixel_x = #{placePixelX},
			place_pixel_y = #{placePixelY},
			sort = #{sort}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		update CMS_TB_ADVERT set
		del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>
	<update id="updateStatus">
		update CMS_TB_ADVERT set
			status = #{status}
			,update_date = sysdate
			<if test="status == 3">
				,RELEASE_DATE = sysdate
			</if>
		WHERE id in
			<foreach item="id" index="index" collection="ids" open="(" separator="," close=")">  
			 	#{id}
			</foreach> 
	</update>
	<select id="findAdPlaceList" resultType="com.klht.modules.cms.entity.AdPlace">
		SELECT 
			a.id AS "id",
			a.place_name AS "placeName",
			a.place_pixel_x AS "placePixelX",
			a.place_pixel_y AS "placePixelY",
			a.place_price AS "placePrice",
			b.NAME as adTypeName,
			b.ID as adTypeId,
			(select count(*) from CMS_TB_ADVERT c where c.del_flag = 0 and c.AD_PLACE_ID = a.id) AS "totalAdCount",
			(select count(*) from CMS_TB_ADVERT c where c.del_flag = 0 and c.status = 3 and c.AD_PLACE_ID = a.id) AS "releaseAdCount"
		FROM cms_tb_ad_place a,CMS_TB_CLASSIFY b
		where a.del_flag = #{DEL_FLAG_NORMAL} and a.ad_type_id = b.id
		<if test="placeName != null and placeName != ''">
	  		AND a.place_name LIKE 
	  		<if test="dbName == 'oracle'">'%'||#{placeName}||'%'</if>
			<if test="dbName == 'mysql'">CONCAT('%', #{placeName}, '%')</if>
		</if>
		<if test="adTypeId != null and adTypeId != -1">
	  		AND a.ad_type_id = #{adTypeId}
		</if>
		<if test="placePrice != null and placePrice != -2">
			<choose>
				<when test="placePrice == -1">
					AND (a.place_price = -1 or a.place_price is null)
				</when>
				<when test="placePrice == 0">
					AND a.place_price = 0
				</when>
				<otherwise>
					AND a.place_price > 0
				</otherwise>
			</choose>
		</if>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.update_date DESC
			</otherwise>
		</choose>
	</select>
</mapper>