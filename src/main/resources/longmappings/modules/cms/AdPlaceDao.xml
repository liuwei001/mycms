<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.klht.modules.cms.dao.AdPlaceDao">
    
	<sql id="adPlaceColumns">
		a.id AS "id",
		a.place_name AS "placeName",
		a.place_desc AS "placeDesc",
		a.place_demo_img AS "placeDemoImg",
		a.is_can_order AS "isCanOrder",
		a.is_limit_ad_num AS "isLimitAdNum",
		a.max_ad_num AS "maxAdNum",
		a.ad_type_id AS "adTypeId",
		a.place_pixel_x AS "placePixelX",
		a.place_pixel_y AS "placePixelY",
		a.place_price AS "placePrice",
		a.default_ad_script AS "defaultAdScript",
		a.create_date AS "createDate",
		a.create_by AS "createBy.id",
		a.update_date AS "updateDate",
		a.update_by AS "updateBy.id"
	</sql>
	
	<sql id="adPlaceJoins">
	</sql>
    
	<select id="get" resultType="AdPlace">
		SELECT 
			<include refid="adPlaceColumns"/>
		FROM cms_tb_ad_place a
		WHERE a.id = #{id}
	</select>
	
	<select id="findList" resultType="AdPlace">
		SELECT 
			<include refid="adPlaceColumns"/>,
			b.NAME as adTypeName,
			(select count(*) from CMS_TB_ADVERT c where c.del_flag = 0 and c.AD_PLACE_ID = a.id) AS "totalAdCount",
			(select count(*) from CMS_TB_ADVERT c where c.del_flag = 0 and c.status = 3 and c.AD_PLACE_ID = a.id) AS "releaseAdCount"
		FROM cms_tb_ad_place a,CMS_TB_CLASSIFY b
		where a.del_flag = #{DEL_FLAG_NORMAL} and a.ad_type_id = b.id
		<if test="placeName != null and placeName != ''">
	  		AND a.place_name LIKE 
	  		<if test="dbName == 'oracle'">'%'||#{placeName}||'%'</if>
			<if test="dbName == 'mysql'">CONCAT('%', #{placeName}, '%')</if>
		</if>
		<if test="adTypeId != null and adTypeId != -1">
	  		AND a.ad_type_id = #{adTypeId}
		</if>
		<if test="placePrice != null and placePrice != -2">
			<choose>
				<when test="placePrice == -1">
					AND (a.place_price = -1 or a.place_price is null)
				</when>
				<when test="placePrice == 0">
					AND a.place_price = 0
				</when>
				<otherwise>
					AND a.place_price > 0
				</otherwise>
			</choose>
		</if>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.update_date DESC
			</otherwise>
		</choose>
	</select>
	
	<select id="findAllList" resultType="AdPlace">
		SELECT 
			<include refid="adPlaceColumns"/>
		FROM cms_tb_ad_place a
		where del_flag = #{DEL_FLAG_NORMAL}		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.update_date DESC
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert">
		<selectKey keyProperty="id" resultType="long" order="BEFORE">
	     	select SEQ_cms_tb_ad_place.nextval from dual
	    </selectKey>
		INSERT INTO cms_tb_ad_place(
			id,
			place_name,
			place_desc,
			place_demo_img,
			is_can_order,
			is_limit_ad_num,
			max_ad_num,
			ad_type_id,
			place_pixel_x,
			place_pixel_y,
			place_price,
			default_ad_script,
			create_date,
			create_by,
			UPDATE_BY,
        	UPDATE_DATE, 
			DEL_FLAG
		) VALUES (
			#{id},
			#{placeName},
			#{placeDesc},
			#{placeDemoImg},
			#{isCanOrder},
			#{isLimitAdNum},
			#{maxAdNum},
			#{adTypeId},
			#{placePixelX},
			#{placePixelY},
			#{placePrice},
			#{defaultAdScript},
			#{createDate},
			#{createBy.id},
			#{updateBy.id},  
			#{updateDate},
			#{DEL_FLAG_NORMAL}
		)
	</insert>
	
	<update id="update">
		UPDATE cms_tb_ad_place SET 	
			place_name = #{placeName},
			place_desc = #{placeDesc},
			place_demo_img = #{placeDemoImg},
			is_can_order = #{isCanOrder},
			is_limit_ad_num = #{isLimitAdNum},
			max_ad_num = #{maxAdNum},
			ad_type_id = #{adTypeId},
			place_pixel_x = #{placePixelX},
			place_pixel_y = #{placePixelY},
			place_price = #{placePrice},
			default_ad_script = #{defaultAdScript},
			update_date = #{updateDate},
			update_by = #{updateBy.id}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		update cms_tb_ad_place set
		del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>
	<select id="findAdList" resultType="com.klht.modules.cms.entity.Advert">
		SELECT 
			t1.ID,t1.AD_NAME,t1.AD_PLACE_ID,t1.AD_START_TM,t1.AD_END_TM,t1.STATUS,t1.TYPE,t1.AD_TYPE_ID,t1.VIP_NAME,
			t2.NAME adTypeName
		FROM CMS_TB_ADVERT t1,CMS_TB_CLASSIFY t2
		where t1.del_flag = #{DEL_FLAG_NORMAL} and AD_PLACE_ID = #{adPlaceId} and t1.AD_TYPE_ID = t2.ID
		<if test="adName != null and adName != ''">
	  		AND t1.AD_NAME LIKE
	  		<if test="dbName == 'oracle'">'%'||#{adName}||'%'</if>
			<if test="dbName == 'mysql'">CONCAT('%', #{adName}, '%')</if>
		</if>
		<if test="status != null and status != -1">
	  		AND t1.STATUS = #{status}
		</if>
		<if test="type != null and type == 0">
	  		AND t1.TYPE = #{type}
		</if>
		<if test="type != null and type == 1">
	  		AND t1.TYPE = #{type}
	  		<if test="vipName != null and vipName != ''">
		  		AND t1.VIP_NAME LIKE
		  		<if test="dbName == 'oracle'">'%'||#{vipName}||'%'</if>
				<if test="dbName == 'mysql'">CONCAT('%', #{vipName}, '%')</if>
	  		</if>
		</if>
		<if test="beginDate != null and beginDate != ''">
				AND t1.AD_START_TM <![CDATA[ >= #{beginDate} ]]>
			</if>
			<if test="endDate != null and endDate != ''">
				AND t1.AD_END_TM <![CDATA[ <= #{endDate} ]]>
			</if>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY t1.update_date DESC
			</otherwise>
		</choose>
	</select>
</mapper>