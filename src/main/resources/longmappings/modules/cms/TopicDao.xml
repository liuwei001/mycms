<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.klht.modules.cms.dao.TopicDao">
    
	<sql id="allColumns">
        t1.ID,
        t1.CREATE_BY AS "createBy.id",
        t1.CREATE_DATE, 
        t1.UPDATE_BY AS "updateBy.id",
        t1.UPDATE_DATE,
        t1.DEL_FLAG,
        t1.TOPIC_CHNL_ID,t1.TOPIC_TITLE,t1.TOPIC_IMG,t1.DESCRIPTION,t1.TAGS,t1.KEYWORDS,t1.STATUS
    </sql>
	
	<!-- 根据编号获得用户 -->
	<select id="get" resultType="topic">
		SELECT
			<include refid="allColumns"/>,
			(select name from CMS_TB_CLASSIFY t2 where t1.TOPIC_CHNL_ID = t2.ID) as TOPIC_CHNL_NAME
		FROM CMS_TB_TOPIC t1
		WHERE id = #{id}
	</select>
	
    
	<select id="findList" resultType="topic" parameterType="topic">
		SELECT 
			<include refid="allColumns"/>,
			t2.NAME as TOPIC_CHNL_NAME,
			(select count(1) from CMS_TB_TOPIC_CONTENT t3 where t1.ID = t3.TOPIC_ID) as contentNum
		FROM CMS_TB_TOPIC t1,CMS_TB_CLASSIFY t2 
	  	WHERE t1.del_flag = #{DEL_FLAG_NORMAL} and t1.TOPIC_CHNL_ID = t2.ID
			<if test="topicChnlId != null and topicChnlId != ''">
		  		AND ( t1.TOPIC_CHNL_ID = #{topicChnlId} or 
		  				t1.TOPIC_CHNL_ID in(select Id from CMS_TB_CLASSIFY t2 start with ID = #{topicChnlId} connect by prior id = PARENT_ID)
		  			)
			</if>
		  	<if test="topicTitle != null and topicTitle != ''">
		  		AND t1.TOPIC_TITLE LIKE 
		  		<if test="dbName == 'oracle'">'%'||#{topicTitle}||'%'</if>
				<if test="dbName == 'mysql'">CONCAT('%', #{topicTitle}, '%')</if>
			</if>
			<if test="status != null and status != ''  and status != '-1'">
		  		AND t1.STATUS = #{status}
			</if>
			<if test="beginDate != null and beginDate != ''">
				AND t1.CREATE_DATE <![CDATA[ >= #{beginDate} ]]>
			</if>
			<if test="endDate != null and endDate != ''">
				AND t1.CREATE_DATE <![CDATA[ <= #{endDate} ]]>
			</if>
		ORDER BY decode(t1.status,1,1,4,2,2,3,3,4,5,5),t1.update_date DESC, t1.id DESC
	</select>
	<select id="findAuditList" resultType="topic" parameterType="topic">
		SELECT 
			<include refid="allColumns"/>,
			t2.NAME as TOPIC_CHNL_NAME,
			(select count(1) from CMS_TB_TOPIC_CONTENT t3 where t1.ID = t3.TOPIC_ID) as contentNum
		FROM CMS_TB_TOPIC t1,CMS_TB_CLASSIFY t2 
	  	WHERE t1.del_flag = #{DEL_FLAG_NORMAL} and t1.TOPIC_CHNL_ID = t2.ID and t1.status != 1
			<if test="topicChnlId != null and topicChnlId != ''">
		  		AND ( t1.TOPIC_CHNL_ID = #{topicChnlId} or 
		  				t1.TOPIC_CHNL_ID in(select Id from CMS_TB_CLASSIFY t2 start with ID = #{topicChnlId} connect by prior id = PARENT_ID)
		  			)
			</if>
		  	<if test="topicTitle != null and topicTitle != ''">
		  		AND t1.TOPIC_TITLE LIKE 
		  		<if test="dbName == 'oracle'">'%'||#{topicTitle}||'%'</if>
				<if test="dbName == 'mysql'">CONCAT('%', #{topicTitle}, '%')</if>
			</if>
			<if test="status != null and status != ''  and status != '-1'">
		  		AND t1.STATUS = #{status}
			</if>
			<if test="beginDate != null and beginDate != ''">
				AND t1.CREATE_DATE <![CDATA[ >= #{beginDate} ]]>
			</if>
			<if test="endDate != null and endDate != ''">
				AND t1.CREATE_DATE <![CDATA[ <= #{endDate} ]]>
			</if>
		ORDER BY t1.status,t1.update_date DESC, t1.id DESC
	</select>
		
	<insert id="insert">
		<selectKey keyProperty="id" resultType="long" order="BEFORE">
	     	select SEQ_CMS_TB_CONTENT.nextval from dual
	    </selectKey>
    	insert into CMS_TB_TOPIC(
    		ID,
        	CREATE_BY,
        	CREATE_DATE, 
        	UPDATE_BY,
        	UPDATE_DATE, 
        	DEL_FLAG,
        	TOPIC_CHNL_ID,TOPIC_TITLE,TOPIC_IMG,DESCRIPTION,TAGS,KEYWORDS,STATUS
        )
    	values(
    		#{id},
    		#{createBy.id},  
			#{createDate}, 
			#{updateBy.id},  
			#{updateDate},
			#{DEL_FLAG_NORMAL},
			#{topicChnlId},#{topicTitle},#{topicImg},#{description},#{tags},#{keywords},#{status}
    	)
    </insert>
    
	<update id="update">
    	update CMS_TB_TOPIC SET
    		update_by = #{updateBy.id}, 
			update_date = #{updateDate},
			TOPIC_CHNL_ID = #{topicChnlId},
			TOPIC_TITLE = #{topicTitle},
			TOPIC_IMG = #{topicImg},
			DESCRIPTION = #{description},
			TAGS = #{tags},
			KEYWORDS = #{keywords},
			STATUS = #{status}
		WHERE id = #{id}
    </update>
	
 
	<update id="delete">
		UPDATE CMS_TB_TOPIC SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>
	<update id="updateStatus" parameterType="java.util.Map">
		UPDATE CMS_TB_TOPIC SET 
			STATUS = #{status}
			,update_date = sysdate
			<if test="status == 3">
				,RELEASE_DATE = sysdate
			</if>
		WHERE id in
			<foreach item="id" index="index" collection="ids" open="(" separator="," close=")">  
			 	#{id}
			</foreach>
	</update>
	 
	<select id="selectTopicInnerChnl" resultType="com.klht.modules.cms.entity.TopicInnerChnl">
    	select ID,
        	TOPIC_ID,
        	NAME, 
        	DEL_FLAG
        from CMS_TB_TOPIC_INNER_CHNL
        where TOPIC_ID = #{topicId} and DEL_FLAG = '0'
	</select>
	<insert id="insertTopicInnerChnl" parameterType="com.klht.modules.cms.entity.TopicInnerChnl">
		<selectKey keyProperty="id" resultType="long" order="BEFORE">
	     	select SEQ_CMS_TB_TOPIC_INNER_CHNL.nextval from dual
	    </selectKey>
    	insert into CMS_TB_TOPIC_INNER_CHNL(
    		ID,
        	TOPIC_ID,
        	NAME, 
        	DEL_FLAG
        )
    	values(
    		#{id},
    		#{topicId},  
			#{name}, 
			#{DEL_FLAG_NORMAL}
    	)
	</insert>
	<update id="updateTopicInnerChnl" parameterType="com.klht.modules.cms.entity.TopicInnerChnl">
    	update CMS_TB_TOPIC_INNER_CHNL SET
    		NAME = #{name}, 
			DEL_FLAG = #{delFlag}
		WHERE ID = #{id}
    </update>
    <select id="selectTopicContentList" resultType="com.klht.modules.cms.entity.TopicContent">
    	select t1.ID as topicId,
        	t2.ID as contentId,
        	t2.TITLE as contentTitle, 
        	t4.ID as topicInnerChnlId,
        	t4.NAME as topicInnerChnlName,
        	t3.CREATE_DATE as createDate,
        	t2.CHANNEL_ID as channelId
        from CMS_TB_TOPIC t1,CMS_TB_CONTENT t2,CMS_TB_TOPIC_CONTENT t3,
        	(select id,name from CMS_TB_TOPIC_INNER_CHNL where DEL_FLAG = 0) t4
        where t1.ID = t3.TOPIC_ID and t2.ID = t3.CONTENT_ID and t3.TOPIC_INNER_CHNL_ID = t4.ID(+)
        and t2.DEL_FLAG = 0 and t1.ID = #{topicId}
		  	<if test="contentTitle != null and contentTitle != ''">
		  		AND t2.TITLE LIKE 
		  		<if test="dbName == 'oracle'">'%'||#{contentTitle}||'%'</if>
				<if test="dbName == 'mysql'">CONCAT('%', #{contentTitle}, '%')</if>
			</if>
			<if test="topicInnerChnlId != null and topicInnerChnlId != '-1'">
		  		AND t3.TOPIC_INNER_CHNL_ID = #{topicInnerChnlId}
			</if>
			<if test="beginDate != null and beginDate != ''">
				AND t3.CREATE_DATE <![CDATA[ >= #{beginDate} ]]>
			</if>
			<if test="endDate != null and endDate != ''">
				AND t3.CREATE_DATE <![CDATA[ <= #{endDate} ]]>
			</if>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY t2.update_date DESC, t2.id DESC
			</otherwise>
		</choose>
	</select>
	 <select id="selectTopicContent" resultType="com.klht.modules.cms.entity.TopicContent">
    	select TOPIC_ID as topicId,
        	CONTENT_ID as contentId,
        	TOPIC_INNER_CHNL_ID as topicInnerChnlId
        from CMS_TB_TOPIC_CONTENT
        where TOPIC_ID = #{topicId} and CONTENT_ID = #{contentId}
	</select>
	<insert id="insertTopicContent" parameterType="java.util.Map">
    	insert into CMS_TB_TOPIC_CONTENT(
    		CONTENT_ID,
        	TOPIC_ID,
        	TOPIC_INNER_CHNL_ID, 
        	CREATE_DATE
        )
    	values(
    		#{contentId},
    		#{topicId},  
			#{topicInnerChnlId},
			sysdate
    	)
	</insert>
	<delete id="deleteTopicContent" parameterType="java.util.Map">
    	delete from CMS_TB_TOPIC_CONTENT
    	where TOPIC_ID = #{topicId} and
    		CONTENT_ID in
    		<foreach item="id" index="index" collection="contentIds" open="(" separator="," close=")">  
			 	#{id}
			</foreach>
	</delete>
	<update id="updateTopicContent" parameterType="java.util.Map">
    	update CMS_TB_TOPIC_CONTENT SET
    	TOPIC_INNER_CHNL_ID = #{topicInnerChnlId}
    	where CONTENT_ID = #{contentId} and TOPIC_ID = #{topicId}
	</update>
	<select id="selectContent" resultType="com.klht.modules.cms.entity.Content">
    	select 
        	ID, TITLE, TYPE, AUTHOR, CREATE_DATE,ORIGIN,STATUS
        from CMS_TB_CONTENT t1
        where not exists (select * from CMS_TB_TOPIC_CONTENT t2 where t1.ID = t2.CONTENT_ID and t2.TOPIC_ID = #{topicId})
        	and t1.DEL_FLAG = 0 and CHANNEL_ID != -1 and t1.STATUS = 3 and CHANNEL_ID != 0
       	 	<if test="channelId != null and channelId != -1">
		  		AND ( CHANNEL_ID = #{channelId} or 
		  				CHANNEL_ID in(select Id from CMS_TB_CLASSIFY t2 start with ID = #{channelId} connect by prior id = PARENT_ID)
		  			)
			</if>
		  	<if test="contentTitle != null and contentTitle != ''">
		  		AND TITLE LIKE 
		  		<if test="dbName == 'oracle'">'%'||#{contentTitle}||'%'</if>
				<if test="dbName == 'mysql'">CONCAT('%', #{contentTitle}, '%')</if>
			</if>
			<if test="status != null and status!='' and status != '-1'">
		  		AND STATUS = #{status}
			</if>
			<if test="beginDate != null and beginDate != ''">
				AND CREATE_DATE <![CDATA[ >= #{beginDate} ]]>
			</if>
			<if test="endDate != null and endDate != ''">
				AND CREATE_DATE <![CDATA[ <= #{endDate} ]]>
			</if>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY t1.update_date DESC, t1.id DESC
			</otherwise>
		</choose>
	</select>
</mapper>